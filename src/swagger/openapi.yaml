openapi: 3.1.0
info:
  title: OnlyUsedTesla API
  version: 0.1.1
servers:
  - url: https://apiv2.onlyusedtesla.com
  - url: http://localhost:3003

tags:
  - name: Health
  - name: Auth

security:
  - bearerAuth: []

paths:
  /health:
    get:
      tags: [Health]
      summary: Service liveness
      security: []
      responses:
        '200': { $ref: '#/components/responses/R200' }
        '500': { $ref: '#/components/responses/R500' }

  /health/cosmos:
    get:
      tags: [Health]
      summary: Cosmos connectivity
      security: []
      responses:
        '200': { $ref: '#/components/responses/R200' }
        '500': { $ref: '#/components/responses/R500' }

  /health/storage:
    get:
      tags: [Health]
      summary: Azure Storage connectivity
      security: []
      responses:
        '200': { $ref: '#/components/responses/R200' }
        '500': { $ref: '#/components/responses/R500' }

  /auth/signup/private:
    post:
      tags: [Auth]
      summary: Sign up as Private seller
      parameters:
        - { $ref: '#/components/parameters/XCountry' }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SignUpPrivate' }
      responses:
        '201': { $ref: '#/components/responses/R201' }
        '422': { $ref: '#/components/responses/R422' }
        '500': { $ref: '#/components/responses/R500' }

  /auth/signup/dealer:
    post:
      tags: [Auth]
      summary: Sign up as Dealer (creates user + seller + optional sellerGroup)
      parameters:
        - { $ref: '#/components/parameters/XCountry' }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SignUpDealer' }
      responses:
        '201': { $ref: '#/components/responses/R201' }
        '422': { $ref: '#/components/responses/R422' }
        '500': { $ref: '#/components/responses/R500' }

  /auth/signin:
    post:
      tags: [Auth]
      summary: Sign in (email + password)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SignIn' }
      responses:
        '200': { $ref: '#/components/responses/R200' }
        '401': { $ref: '#/components/responses/R401' }
        '422': { $ref: '#/components/responses/R422' }
        '500': { $ref: '#/components/responses/R500' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    XCountry:
      name: X-Country
      in: header
      description: Optional country isolation for non-admin routes.
      required: false
      schema: { type: string, example: "US" }

  schemas:
    SignUpPrivate:
      type: object
      required:
        [firstName, lastName, email, phone, password, confirmPassword, acceptTos]
      properties:
        firstName: { type: string }
        lastName:  { type: string }
        email:     { type: string, format: email }
        phone:     { type: string }
        zipCode:   { type: string }
        password:  { type: string, minLength: 8 }
        confirmPassword: { type: string, minLength: 8 }
        acceptTos: { type: boolean }
        country:   { type: string, example: "US" }

    SignUpDealer:
      type: object
      required:
        [firstName, lastName, email, phone, address, password, confirmPassword, whoAreYouRepresenting, businessType, companyName, syndicationSystem, subscriptionIds, acceptTos]
      properties:
        firstName: { type: string }
        lastName:  { type: string }
        email:     { type: string, format: email }
        phone:     { type: string }
        address:   { type: string }
        password:  { type: string, minLength: 8 }
        confirmPassword: { type: string, minLength: 8 }
        whoAreYouRepresenting:
          type: string
          enum: [SingleDealer, GroupDealer]
        dealerGroupName:
          type: string
          description: Required if whoAreYouRepresenting=GroupDealer
        businessType: { type: string }
        companyName:  { type: string }
        syndicationSystem: { type: string, example: "vAuto" }
        owner:
          type: object
          properties:
            isOwner: { type: boolean }
            name: { type: string }
            email: { type: string, format: email }
        businessSites:
          type: array
          items: { type: string }
        subscriptionIds:
          type: array
          items: { type: string }
          description: Stripe price IDs (one or more)
        acceptTos: { type: boolean }
        country:   { type: string, example: "US" }

    SignIn:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }

    # ------------------ Response Schemas ------------------
    Success:
      type: object
      additionalProperties: false
      properties:
        success: { type: boolean, const: true }
        data: {}
        meta:
          type: object
          properties:
            limit: { type: integer }
            continuationToken: { type: string, nullable: true }
            count: { type: integer }
      required: [success, data]

    Problem:
      type: object
      additionalProperties: true
      properties:
        type:      { type: string, format: uri, default: "about:blank" }
        title:     { type: string }
        status:    { type: integer }
        detail:    { type: string }
        instance:  { type: string }
        requestId: { type: string }
      required: [title, status]

    ValidationProblem:
      allOf:
        - $ref: '#/components/schemas/Problem'
        - type: object
          properties:
            errors:
              type: array
              items:
                type: object
                properties:
                  path: { type: string }
                  code: { type: string }
                  message: { type: string }

    AuthTokens:
      type: object
      properties:
        accessToken: { type: string }
        refreshToken:{ type: string }
        tokenType:   { type: string, example: "Bearer" }
        expiresIn:   { type: integer, example: 900 }

  responses:
    R200:
      description: OK
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Success' }
          examples:
            signin:
              summary: Successful sign in
              value:
                success: true
                data:
                  accessToken: "eyJhbGciOiJFZERTQSIs..."
                  refreshToken: "eyJhbGciOiJFZERTQSIs..."
                  tokenType: "Bearer"
                  expiresIn: 900

    R201:
      description: Created
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Success' }
          examples:
            signupPrivate:
              summary: Private signup created
              value:
                success: true
                data:
                  userId: "usr_777"
                  sellerId: "seller_xyz789"
                  emailVerified: false
            signupDealer:
              summary: Dealer signup + optional group
              value:
                success: true
                data:
                  userId: "usr_123"
                  sellerId: "dealer_abc123"
                  dealerGroupId: "dealerGroup_456"
                  checkout:
                    provider: "stripe"
                    status: "created"
                    sessionId: "cs_test_123"
                    url: "https://checkout.stripe.com/c/pay/cs_test_123"

    R204:
      description: No Content

    R400:
      description: Bad Request
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            bad:
              value:
                type: "about:blank"
                title: "Bad Request"
                status: 400
                detail: "Malformed query parameter."

    R401:
      description: Unauthorized
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            unauthorized:
              value:
                type: "about:blank"
                title: "Unauthorized"
                status: 401
                detail: "Invalid bearer token."

    R403:
      description: Forbidden
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            forbidden:
              value:
                type: "about:blank"
                title: "Forbidden"
                status: 403
                detail: "Missing permissions."

    R404:
      description: Not Found
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            missing:
              value:
                type: "about:blank"
                title: "Not Found"
                status: 404
                detail: "Resource not found."

    R422:
      description: Validation Failed
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/ValidationProblem' }
          examples:
            validation:
              value:
                type: "about:blank"
                title: "Validation Failed"
                status: 422
                detail: "Invalid field values"
                errors:
                  - path: "password"
                    message: "Must be at least 8 characters"
                  - path: "email"
                    message: "Invalid email"

    R429:
      description: Too Many Requests
      headers:
        Retry-After:
          description: Seconds before retry
          schema: { type: integer }
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            throttled:
              value:
                type: "about:blank"
                title: "Too Many Requests"
                status: 429
                detail: "Rate limit exceeded."

    R500:
      description: Internal Server Error
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            boom:
              value:
                type: "about:blank"
                title: "Internal Server Error"
                status: 500
                detail: "Unexpected error occurred."